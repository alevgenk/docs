Viber HTTP API
==============

Общие сведения
--------------

API предоставляет  интерфейс для автоматизации процесса отправки мгновенных сообщений Viber мессенджера через платформу Devino Telecom.
С помощью API можно производить пакетные рассылки, отправлять транзакционные сообщения, а также осуществлять переотправку SMS в случае недоставки  Viber сообщений одной командой.

Работа с API осуществляется с использованием метода HTTP-POST.
Тела запроса клиента и ответа сервера представлены в формате JSON. Данные должны быть в кодировке UTF-8.

API поддерживает базовую авторизацию через заголовок Authorization (https://en.wikipedia.org/wiki/Basic_access_authentication).
В заголовке запроса необходимо передать логин и пароль из Личного Кабинета в формате login:password в base64 кодировке.

Например:

.. code-block:: python

    Authorization: Basic dGVzdGVyOjExMTExMQ==
    

Точка подключения: 

.. code-block:: json

  https://viber.devinotele.com:444  
    
 
Используемые типы данных:

+------------------+--------------------------------------------------------------------------------------------+
| Тип данных       | Описание                                                                                   |
+==================+============================================================================================+
|     Integer      | Положительные числа больше нуля                                                            |
+------------------+--------------------------------------------------------------------------------------------+
|   DateTime       | Значение, обозначающее дату и время, представляются в                                      |
|                  | пакетах в формате «yyyy-MMdd hh:mm:ss», например, 1999-05-31 13:20:00                      |
+------------------+--------------------------------------------------------------------------------------------+
| Address          | Адрес абонента. Номер мобильного телефона абонента в международном                         |
|                  | формате (в формате E.164). Например, 79031112233, для России или 491791112233 для Германии |
+------------------+--------------------------------------------------------------------------------------------+
| String           | Строка символов в формате UTF-8                                                            |
+------------------+--------------------------------------------------------------------------------------------+

Ограничения и допустимые значения описаны далее в разделе описания пакетов протокола

Отправка сообщения
------------------

.. code-block:: json

  https://viber.devinotele.com:444/send

Метод служит для отправки сообщения на указанные номера абонента. Параметры сообщения и адреса абонентов передаются в теле запроса в формате JSON.

Типы сообщений, допустимые к отправке:

+----------------------+--------------------------+--------------------+
|    Тип сообщения     | Возможность переотправки |    contentType     |
+======================+==========================+====================+
| Текст+кнопка         |   Да                     |  button            |
+----------------------+--------------------------+--------------------+
|Текст+картинка+кнопка |   Да                     |  button            |
+----------------------+--------------------------+--------------------+
| Текст                |   Да                     |  text              |
+----------------------+--------------------------+--------------------+
| Картинка             |   Нет                    |  image             |
+----------------------+--------------------------+--------------------+

Отправка текстового сообщений
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Запрос на отправку текстового сообщения собирается с указанием contentType: "text". Возможна переотправка по СМС.

Пример запроса:

**https://viber.devinotele.com:444/send**

.. code-block:: python

    {
        "resendSms" : "true",
        "messages" :
            [ {
                "subject" : "Subject",
                "priority" : "high",
                "validityPeriodSec" : 3600,
                "comment" : "comment",
                "type" : "viber",
                "contentType" : "text",
                "content" :
                {
                     "text" : "Message text"
                },
                "address" : "79250000000",
         
            "smsText":"1sms Message text",
            "smsSrcAddress":"1TEST",
            "smsValidityPeriodSec":5000
        } ]
    }
    

**Описание полей тела запроса отправки сообщения:**

+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
|    Параметр     | Тип данных |    Описание                                |  Допустимые значения                    | Обязательное |
|                 |            |                                            |                                         | поле         |
+=================+============+============================================+=========================================+==============+
| resendSms       |   boolean  | Признак переотправки сообщения,            | **true** –  переотправка включена       | Нет          |
|                 |            | по умолчанию                               | **false**– переотправка выключена       |              |
|                 |            | (если параметр не передаётся)              |                                         |              |
|                 |            |    - переотправка выключена                |                                         |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| subject         |   String   | Подпись для сообщения, которая отображается| Все подписи предварительно должны       | Нет          |
|                 |            | в мессенджере абонента                     | регистрироваться на платформе провайдера|              |
|                 |            |                                            | Длина имени не более 11 символов.       |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| priority        |   String   | Приоритет сообщения. Используется для      |  low – низкий приоритет.                | Да           |
|                 |            | управления оперативностью доставки         |  normal – нормальный приоритет          |              |
|                 |            | сообщения абоненту. Для транзакционных     |  high – высокий приоритет.              |              |
|                 |            | сообщений приоритет должен быть            |  realtime – высочайший приоритет        |              |
|                 |            | высоким, для рекламы низким.               |                                         |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
|validityPeriodSec|   Integer  | Время ожидания доставки Viber сообщения    | 15 – 86400. Если параметр не указан,    | Нет          |
|                 |            | в секундах                                 | время ожидания доставки будет           |              |
|                 |            |                                            | выставлено по-умолчанию в               |              |
|                 |            |                                            | максимальное значение.                  |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| comment         |   String   | Произвольный текстовый комментарий.        |                                         | Нет          |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| type            |   String   | Тип отправляемого сообщения. Определяет    | viber – Viber messenger                 | Да           |
|                 |            | канал, которые используется для доставки   |                                         |              |
|                 |            | сообщения на мобильный телефон абонента    |                                         |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| contentType     |   String   | Тип содержимого сообщения.                 | text – текстовое сообщение              | Да           |
|                 |            |                                            | image – изображение                     |              |
|                 |            |                                            | button – гиперссылка в виде кнопки      |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| content         | Составной  | Содержимое сообщения.                      | Определяется значением contentType      | Да           |
|                 | тип        | Зависит от значения contentType            |                                         |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| address         | Address    | Номер телефона абонента, на который        | Положительные целые числа. Номер        | Да           |
|                 |            | отправляется сообщение                     | мобильного телефона абонента в          |              |
|                 |            |                                            | международном формате (в формате E.164) |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| smsText         | String     | Текст СМС сообщения                        |                                         | Нет          |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| smsSrcAddress   | String     | Адрес отправителя СМС сообщения            | Адрес отправителя должен быть согласован| Нет          |
|                 |            |                                            | на СМС в личном кабинете, длина имени не|              |
|                 |            |                                            | более 11 латинский символов или цифр.   |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| smsValidity     |   Integer  | Время ожидания доставки СМС сообщения      | 15 – 86400. Если параметр не указан, то | Нет          |
| PeriodSec       |            | в секундах                                 | время жизни сообщения будет выставлено  |              |
|                 |            |                                            | по-умолчанию СМС-центром оператора.     |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+


Пример ответа:

.. code-block:: python

    {
        "status" : "ok"
        "messages" :
            [ {
                "providerId" : 54321,
                "code" : "ok"
            } ]
    }
   
  
**Описание полей ответа на запрос отправки сообщения:**

+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
|    Параметр     | Тип данных |    Описание                                |  Допустимые значения                    | Обязательное |
|                 |            |                                            |                                         | поле         |
+=================+============+============================================+=========================================+==============+
| status          | String     | Статус ответа провайдера на запрос send    | Список возможных кодов и их значений    | Да           |
|                 |            |                                            | указан в таблице кодов возврата         |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| providerId      | Integer    | Поле возвращается только в случае когда код| Положительные целые числа               | Нет          |
|                 |            | ответа провайдера для сообщения равен “ok”.|                                         |              |
|                 |            | На стороне клиента providerId должно       |                                         |              |
|                 |            | сохраняться для последующего запроса       |                                         |              |
|                 |            | статуса сообщения.                         |                                         |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| code            |   String   | Код ответа провайдера для конкретного      | Список возможных кодов и их значений    | Да           |
|                 |            | сообщения                                  | указан в таблице кодов возврата         |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+


Отправка текста с кнопкой
~~~~~~~~~~~~~~~~~~~~~~~~~

Запрос для отправки абоненту текста с кнопкой в качестве сообщения отличается от запроса для отправки простого текстового сообщения кодом contentType, в котором в данном случае нужно указать значение button и заполнить дополнительные атрибуты text, caption, aсtion и imageUrl (при необходимости добавить изображение) составного поля content. Данный тип сообщений поддерживается только в Viber. Возможна переотправка СМС.

Пример запроса отправки кнопки:

**https://viber.devinotele.com:444/send**

.. code-block:: python

        {
            "resendSms" : "true",
            "messages" :
            [ {
                "subject" : "Subject",
                "priority" : "high",
                "validityPeriodSec" : 3600,
                "comment" : "comment",
                "type" : "viber",
                "contentType" : "button",
                "content" : {
                    "text" : "text",
                    "caption" : "caption",
                    "action" : "http://company.com/resource",
                    "imageUrl" : "http://company.com/image.jpg"
                },
                "address" : "79250000000",
                "smsText":"1sms Message text",
                "smsSrcAddress":"1TEST",
                "smsValidityPeriodSec":5000
            } ]
        }
        

Описание полей содержимого для отправки кнопки:

+-----------------+------------+--------------------------------------------+--------------------+
|    Параметр     | Тип данных |    Описание                                |  Обязательное поле | 
+=================+============+============================================+====================+
| text            | String     | Текст сообщения. Не более 1000 символов.   | Да                 |
+-----------------+------------+--------------------------------------------+--------------------+
| caption         | String     | Наименование кнопки. Не более 19 символов. | Да                 |
+-----------------+------------+--------------------------------------------+--------------------+
| action          |   String   | URL страницы, на которую будет отправлен   | Да                 |
|                 |            | пользователь при нажатии на кнопку         |                    |
+-----------------+------------+--------------------------------------------+--------------------+
| imageUrl        |   String   | URL изображения, которое размещено на      | Нет                |
|                 |            | серверах Клиента                           |                    |
+-----------------+------------+--------------------------------------------+--------------------+


Отправка изображения
~~~~~~~~~~~~~~~~~~~~

Запрос для отправки абоненту изображения отличается от запроса для отправки текстового сообщения кодом contentType, в котором в данном случае нужно указать значение image и заполнить дополнительный атрибут imageUrl для составного параметра content. Переотправка не предполагается, т.к. отсутствует поле text. В случае указания resendSms = true для отправки image сервис возвращает ошибку валидации 

Пример запроса отправки изображения:

**https://viber.devinotele.com:444/send**

.. code-block:: python

        {
            "resendSms" : "false",
            "messages" :
            [ {
                "subject" : "Subject",
                "priority" : "high",
                "validityPeriodSec" : 3600,
                "comment" : "comment",
                "type" : "viber",
                "contentType" : "image",
                "content" : {
                    "imageUrl" : "http://company.com/image.jpg"
                },
                "address" : "79250000000"
            } ]
        }
        

Описание полей содержимого отправки изображения:

+-----------------+------------+------------------+--------------------+
|    Параметр     | Тип данных |    Описание      |  Обязательное поле | 
+=================+============+==================+====================+
| imag            | String     | URL изображения  | Да                 |
+-----------------+------------+------------------+--------------------+


Отправка нескольких сообщений
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

При осуществлении массовой рассылки однотипных сообщений, чтобы не дублировать данные, можно использовать секцию запроса messageCommonData, данные из которой будут использованы для всех сообщений в запросе, но могут быть переопределены ими.

Пример отправки нескольких сообщений:

**https://viber.devinotele.com:444/send**

.. code-block:: python

        {
            "resendSms" : "false",
            "commonData" : {
                "subject" : "Subject",
                "priority" : "high",
                "validityPeriodSec" : 3600,
                "comment" : "comment",
                "type" : "viber",
                "contentType" : "button",
                "content" : {
                    "text" : "text",
                    "caption" : "caption",
                    "action" : "http://company.com/resource",
                    "imageUrl" : "http://company.com/image.jpg"
                }
            },
            "messages" :
                [ {
                    "address" : "79250000001"
                },
                {
                    "priority" : "low",
                    "contentType" : "text",
                    "content" : {
                        "text" : "Message text"
                    },
                    "address" : "79250000002"
            } ]
        }
        
В данном примере второе сообщение будет отправлено с текстом «Message text» и с более низким приоритетом.

Проверка статуса доставки сообщения
-----------------------------------

.. code-block:: json

  https://viber.devinotele.com:444/status

Данный метод предназначен для проверки статусов по ранее полученным providerId на запросы "/send"

Пример запроса:

**https://viber.devinotele.com:444/status**

.. code-block:: python

        {
           "messages" :
               [3158611117333282816, 3158611117333282817,3158611117333282818, 3158611117333282819, 3158611117333282820 ]
        }
        
Пример ответа на запрос статуса доставки:

.. code-block:: python

        {
          
           "status": "ok",
           "messages": [
               {
                   "providerId": 3158611117333282816,
                   "code": "ok",
                   "smsStates": [
                       {
                           "id": 583465579822710784,
                           "state": "delivered"
                       },
                       {
                           "id": 583465579822710785,
                           "state": "delivered"
                       },
                       {
                           "id": 583465579822710786,
                           "state": "delivered"
                       },
                       {
                           "id": 583465579822710787,
                           "state": "delivered"
                       },
                       {
                           "id": 583465579822710788,
                           "state": "delivered"
                       },
                       {
                           "id": 583465579822710789,
                           "state": "delivered"
                       },
                       {
                           "id": 583465579822710790,
                           "state": "delivered"
                       },
                       {
                           "id": 583465579822710791,
                           "state": "delivered"
                       },
                       {
                           "id": 583465579822710792,
                           "state": "delivered"
                       },
                       {
                           "id": 583465579822710793,
                           "state": "delivered"
                       },
                       {
                           "id": 583465579822710794,
                           "state": "delivered"
                       },
                       {
                           "id": 583465579822710795,
                           "state": "delivered"
                       },
                       {
                           "id": 583465579822710796,
                           "state": "delivered"
                       },
                       {
                           "id": 583465579822710797,
                           "state": "delivered"
                       }
                   ]
               },
               {
                   "providerId": 3158611117333282818,
                   "code": "ok",
                   "smsStates": [
                       {
                           "id": 583465579822710798,
                           "state": "delivered"
                       }
                   ]
               },
               {
                   "providerId": 3158611117333282820,
                   "code": "ok",
                   "smsStates": [
                       {
                           "id": 583465579822710799,
                           "state": "delivered"
                       }
                   ]
               },
               {
                   "providerId": 3158611117333282817,
                   "code": "ok",
                   "status": "read",
                   "statusAt": "2016-08-10 15:28:50"
               },
               {
                   "providerId": 3158611117333282819,
                   "code": "ok",
                   "status": "read",
                   "statusAt": "2016-08-10 15:28:50"
               }
           ]
        }
        

Описание полей ответа на запрос статуса доставки

+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
|    Параметр     | Тип данных |    Описание                                |  Допустимые значения                    | Обязательное |
|                 |            |                                            |                                         | поле         |
+=================+============+============================================+=========================================+==============+
| status          | String     | Результат обработки запроса                | Возможные коды ошибок и их описание     | Да           |
|                 |            |                                            | определены в таблице кодов возврата     |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| code            | String     | Результат обработки запроса для конкретного| Возможные коды ошибок и их описание     | Да           |
|                 |            | сообщения с провайдеским идентификатором   | определены в таблице кодов возврата     |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| smsStates       | Массив     | Текущий статус доставки СМС сообщения.     |                                         | Нет          |
|                 | (Составное | Указывается, только если была переотправка |                                         |              |
|                 |  поле)     | сообщения.                                 |                                         |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| smsStates.state | String     | Код статуса доставки СМС сообщения         | **enqueued** – сообщение находится в    | Нет          |
|                 |            |                                            | очереди на отправку.                    |              |
|                 |            |                                            | **sent** – сообщение отправлено абоненту|              |
|                 |            |                                            | **delivered** – сообщение доставлено    |              |
|                 |            |                                            | абоненту.                               |              |
|                 |            |                                            | **undelivered** – сообщение отправлено, |              |
|                 |            |                                            | но не доставлено абоненту.              |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| smsStates.id    |   Long     | ID СМС сообщения с СМС-Центра провайдера.  |                                         | Да           |
|                 |            | Если сообщение многосегментное, то будет   |                                         |              |
|                 |            | возвращен ID для каждого сегмента сообщения|                                         |              |
|                 |            | и его статус.                              |                                         |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| Status          | String     | Код статуса доставки Viber сообщения.      | **enqueued** – сообщение находится в    | Да           |
|                 |            |                                            | очереди на отправку.                    |              |
|                 |            |                                            | **sent** – сообщение отправлено абоненту|              |
|                 |            |                                            | **delivered** – сообщение доставлено    |              |
|                 |            |                                            | абоненту.                               |              |
|                 |            |                                            | **read** – сообщение просмотрено        |              |
|                 |            |                                            | абонентом.                              |              |
|                 |            |                                            | **undelivered** – сообщение отправлено, |              |
|                 |            |                                            | но не доставлено абоненту.              |              |
|                 |            |                                            | **failed** – сообщение не было          |              |
|                 |            |                                            | отправлено в результат сбоя.            |              |
|                 |            |                                            | **cancelled** –отправка сообщения       |              |
|                 |            |                                            | отменена.                               |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| statusAt        |  DateTime  | Дата и время получения статуса             |                                         | Да           |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| error           |   String   | Причина, по которой сообщение не было      | **user-blocked** – абонент заблокирован | Нет          |
|                 |            | доставлено абоненту (status=undelivered)   | **not-viber-user** – абонент не является|              |
|                 |            |                                            | пользователем Viber.                    |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+


Таблица кодов возврата
----------------------

**Коды возврата обработки запроса (status)**

+-----------------------------------------------+--------------------------------------------------------------------------+
| Код                                           | Описание                                                                 |
+===============================================+==========================================================================+
| ok                                            | Запрос был успешно обработан                                             |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-syntax                                  | ошибка синтаксиса                                                        |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-auth                                    | ошибка аутентификации                                                    |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-system                                  | системная ошибка                                                         |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-account-locked                          | аккаунт клиента заблокирован                                             |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-instant-message-typeformat              | неправильный формат типа исходящего сообщения                            |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-instant-message-content-type-format     | неправильный формат типа содержимого сообщения                           |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-instant-message-content-image-id-format | неправильный формат идентификатора изображения для содержимого сообщения |
+-----------------------------------------------+--------------------------------------------------------------------------+

**Коды возврата обработки сообщения в рамках запроса (code)**

+-----------------------------------------------+--------------------------------------------------------------------------+
| Код                                           | Описание                                                                 |
+===============================================+==========================================================================+
| ok                                            | исходящее сообщение успешно принято на отправку                          |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-system                                  | системная ошибка                                                         |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-instant-message-client-id-not-unique    | клиентский идентификатор сообщения не уникален в рамках всего            |
|                                               | взаимодействия между клиентом и провайдером.                             |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-subject-format                          | неправильный формат подписи                                              |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-subject-unknown                         |указанная подпись не разрешена клиенту в конфигурации платформы провайдера|
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-subject-not-specified                   | подпись не указана                                                       |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-address-format                          | неправильный формат номера абонента                                      |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-address-unknown                         | отправка на номерную емкость, к которой относится номер абонента не      |
|                                               | разрешена клиенту в конфигурации платформы провайдера                    |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-address-not-specified                   | номер абонента не указан                                                 |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-priority-format                         | неправильный формат значения приоритета                                  |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-comment-format                          | неправильный формат значения комментария                                 |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-instant-message-type-format             | неправильный формат типа сообщения                                       |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-instant-message-type-not-specified      | неправильный формат типа содержимого сообщения                           |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-content-type-format                     | неправильный формат содержимого сообщения                                |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-content-not-specified                   | содержимое сообщения не указано                                          |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-validity-period-seconds-format          | неправильно указано значение времени ожидания доставки                   |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-instant-message-provider-id-format      | неправильный формат провайдерского идентификатора                        |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-instant-message-provider-id-duplicate   | провайдерский идентификатор исходящего сообщения неуникален в рамках     |
|                                               | запроса проверки статуса                                                 |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-instant-message-provider-id-unknown     | исходящее сообщение с данным провайдерским идентификатором не найдено    |
|                                               | на платформе провайдера                                                  |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-resend-sms-error                        | указаны поля для переотправки смс но переотправка не включена            |
+-----------------------------------------------+--------------------------------------------------------------------------+
| error-resend-sms-validity-period-error        | неверное время жизни для смс                                             |
+-----------------------------------------------+--------------------------------------------------------------------------+
