Viber-Resender (Client Documentation)
=====================================

Общие сведения
--------------

API предоставляет  интерфейс для автоматизации процесса отправки мгновенных сообщений Viber мессенджера через платформу Devino Telecom.
С помощью API можно производить пакетные рассылки, отправлять транзакционные сообщения, а также осуществлять переотправку SMS в случае недоставки  Viber сообщений одной командой.
Работа с API осуществляется с использованием метода HTTP-POST.
Тела запроса клиента и ответа сервера представлены в формате JSON. Данные должны быть в кодировке UTF-8.
API поддерживает базовую авторизацию через заголовок Authorization (https://en.wikipedia.org/wiki/Basic_access_authentication).
В заголовке запроса необходимо передать логин и пароль из Личного Кабинета в формате login:password в base64 кодировке.

Например:

.. code-block:: python

    Authorization: Basic dGVzdGVyOjExMTExMQ==
    
Используемые типы данных:

+------------------+--------------------------------------------------------------------------------------------+
| Тип данных       | Описание                                                                                   |
+==================+============================================================================================+
|     Integer      | Положительные числа больше нуля                                                            |
+------------------+--------------------------------------------------------------------------------------------+
|   DateTime       | Значение, обозначающее дату и время, представляются в                                      |
|                  | пакетах в формате «yyyy-MMdd hh:mm:ss», например, 1999-05-31 13:20:00                      |
+------------------+--------------------------------------------------------------------------------------------+
| Address          | Адрес абонента. Номер мобильного телефона абонента в международном                         |
|                  | формате (в формате E.164). Например, 79031112233, для России или 491791112233 для Германии |
+------------------+--------------------------------------------------------------------------------------------+
| String           | Строка символов в формате UTF-8                                                            |
+------------------+--------------------------------------------------------------------------------------------+

Ограничения и допустимые значения описаны далее в разделе описания пакетов протокола

Методы работы с API
-------------------

**Отправка сообщения (/send)**
Метод служит для отправки сообщения на указанные номера абонента. Параметры сообщения и адреса абонентов передаются в теле запроса в формате JSON.

Типы сообщений, допустимые к отправке:

+----------------------+--------------------------+--------------------+
|    Тип сообщения     | Возможность переотправки |    contentType     |
+======================+==========================+====================+
| Текст+кнопка         |   Да                     |  button            |
+----------------------+--------------------------+--------------------+
|Текст+картинка+кнопка |   Да                     |  button            |
+----------------------+--------------------------+--------------------+
| Текст                |   Да                     |  text              |
+----------------------+--------------------------+--------------------+
| Картинка             |   Нет                    |  image             |
+----------------------+--------------------------+--------------------+

**Отправка текстового сообщений**

Запрос на отправку текстового сообщения собирается с указанием contentType: "text". Возможна переотправка по СМС.

Пример запроса:
**http(s)://<host>:<port>/send**

.. code-block:: python

    {
        "resendSms" : "true",
        "messages" :
            [ {
                "subject" : "Subject",
                "priority" : "high",
                "validityPeriodSec" : 3600,
                "comment" : "comment",
                "type" : "viber",
                "contentType" : "text",
                "content" :
                {
                     "text" : "Message text"
                },
                "address" : "79250000000",
         
            "smsText":"1sms Message text",
            "smsSrcAddress":"1TEST",
            "smsValidityPeriodSec":5000
        } ]
    }
    
Описание полей тела запроса отправки сообщения:

+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
|    Параметр     | Тип данных |    Описание                                |  Допустимые значения                    | Обязательное |
|                 |            |                                            |                                         | поле         |
+=================+============+============================================+=========================================+==============+
| resendSms       |   boolean  | Признак переотправки сообщения,            | **true** –  переотправка включена       | Нет          |
|                 |            | по умолчанию                               | **false**– переотправка выключена       |              |
|                 |            | (если параметр не передаётся)              |                                         |              |
|                 |            |    - переотправка выключена                |                                         |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| subject         |   String   | Подпись для сообщения, которая отображается| Все подписи предварительно должны       | Нет          |
|                 |            | в мессенджере абонента                     |регистрироваться на платформе провайдера.|              |
|                 |            |                                            | Длина имени не более 11 символов.       |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| priority        |   String   | Приоритет сообщения. Используется для      |  low – низкий приоритет.                | Да           |
|                 |            | управления оперативностью доставки         |  normal – нормальный приоритет          |              |
|                 |            | сообщения абоненту. Для транзакционных     |  high – высокий приоритет.              |              |
|                 |            | сообщений приоритет должен быть            |  realtime – высочайший приоритет        |              |
|                 |            | высоким, для рекламы низким.               |                                         |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
|validityPeriodSec|   Integer  | Время ожидания доставки Viber сообщения    | 15 – 86400. Если параметр не указан,    | Нет          |
|                 |            | в секундах                                 | время ожидания доставки будет           |              |
|                 |            |                                            | выставлено по-умолчанию в               |              |
|                 |            |                                            | максимальное значение.                  |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| comment         |   String   | Произвольный текстовый комментарий.        |                                         | Нет          |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| type            |   String   | Тип отправляемого сообщения. Определяет    | viber – Viber messenger                 | Да           |
|                 |            | канал, которые используется для доставки   |                                         |              |
|                 |            | сообщения на мобильный телефон абонента    |                                         |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| contentType     |   String   | Тип содержимого сообщения.                 | text – текстовое сообщение              | Да           |
|                 |            |                                            | image – изображение                     |              |
|                 |            |                                            | button – гиперссылка в виде кнопки      |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| content         | Составной  | Содержимое сообщения.                      | Определяется значением contentType      | Да           |
|                 | тип        | Зависит от значения contentType            |                                         |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| address         | Address    | Номер телефона абонента, на который        | Положительные целые числа. Номер        | Да           |
|                 |            | отправляется сообщение                     | мобильного телефона абонента в          |              |
|                 |            |                                            | международном формате (в формате E.164) |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| smsText         | String     | Текст СМС сообщения                        |                                         | Нет          |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| smsSrcAddress   | String     | Адрес отправителя СМС сообщения            | Адрес отправителя должен быть согласован| Нет          |
|                 |            |                                            | на СМС в личном кабинете, длина имени не|              |
|                 |            |                                            | более 11 латинский символов или цифр.   |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| smsValidity     |   Integer  | Время ожидания доставки СМС сообщения      | 15 – 86400. Если параметр не указан, то | Нет          |
| PeriodSec       |            | в секундах                                 | время жизни сообщения будет выставлено  |              |
|                 |            |                                            | по-умолчанию СМС-центром оператора.     |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+

Пример ответа:

.. code-block:: python

    {
        "status" : "ok"
        "messages" :
            [ {
                "providerId" : 54321,
                "code" : "ok"
            } ]
    }
    
Описание полей ответа на запрос отправки сообщения:

+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
|    Параметр     | Тип данных |    Описание                                |  Допустимые значения                    | Обязательное |
|                 |            |                                            |                                         | поле         |
+=================+============+============================================+=========================================+==============+
| status          | String     | Статус ответа провайдера на запрос send    | Список возможных кодов и их значений    | Да           |
|                 |            |                                            | указан в таблице кодов возврата         |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| providerId      | Integer    | Поле возвращается только в случае когда код| Положительные целые числа               | Нет          |
|                 |            | ответа провайдера для сообщения равен “ok”.|                                         |              |
|                 |            | На стороне клиента providerId должно       |                                         |              |
|                 |            | сохраняться для последующего запроса       |                                         |              |
|                 |            | статуса сообщения.                         |                                         |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+
| code            |   String   | Код ответа провайдера для конкретного      | Список возможных кодов и их значений    | Да           |
|                 |            | сообщения                                  | указан в таблице кодов возврата         |              |
+-----------------+------------+--------------------------------------------+-----------------------------------------+--------------+


Отправка текста с кнопкой
-------------------------

Запрос для отправки абоненту текста с кнопкой в качестве сообщения отличается от запроса для отправки простого текстового сообщения кодом contentType, в котором в данном случае нужно указать значение button и заполнить дополнительные атрибуты text, caption, aсtion и imageUrl (при необходимости добавить изображение) составного поля content. Данный тип сообщений поддерживается только в Viber. Возможна переотправка СМС.

Пример запроса отправки кнопки:
**http(s)://<host>:<port>/send**


